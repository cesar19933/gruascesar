<script>
document.addEventListener('DOMContentLoaded', () => {
  const PHONE_E164 = '+34633078354';
  const PHONE_DIGITS = PHONE_E164.replace('+','');

  const linea = v => (v && String(v).trim()) ? String(v).trim() : null;

  function normalizarTelefono(valor){
    let n = String(valor || '').replace(/[^0-9+]/g,'').trim();
    if (!n) return '';
    if (n.startsWith('00')) n = '+' + n.slice(2);
    if (n.startsWith('+')) {
      const d = n.replace(/[^\d]/g,'');
      return d ? '+' + d : '';
    }
    if (/^[6-9]\d{8}$/.test(n)) return '+34' + n;
    if (n.startsWith('34') && n.length >= 11) return '+' + n;
    const d = n.replace(/[^\d]/g,'');
    return d ? '+' + d : '';
  }

  // AÃ±o dinÃ¡mico (sin crashear)
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // GEO
  let gps = null;
  const gpsBtn = document.getElementById('gpsBtn');
  const estado = document.getElementById('estado');

  function setEstado(msg){
    if (estado) estado.textContent = msg || '';
  }

  if (gpsBtn){
    gpsBtn.addEventListener('click', () => {
      setEstado('Solicitando ubicaciÃ³nâ€¦');
      if (!navigator.geolocation){
        setEstado('Tu navegador no soporta GPS.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          gps = {
            lat: pos.coords.latitude.toFixed(6),
            lng: pos.coords.longitude.toFixed(6),
            acc: Math.round(pos.coords.accuracy)
          };
          setEstado(`UbicaciÃ³n aÃ±adida (Â±${gps.acc} m)`);
        },
        () => setEstado('No se pudo obtener la ubicaciÃ³n.'),
        { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
      );
    });
  }

  // SERVICIOS
  const SERVICES = [
    { text:"ExtracciÃ³n de parking", icon:"ðŸšš" },
    { text:"Cambio de baterÃ­a (AGM/EFB y convencionales)", icon:"ðŸ”‹" },
    { text:"Pinchazo / rueda", icon:"ðŸ›ž" },
    { text:"Arranque con pinzas", icon:"âš¡" },
    { text:"Traslado de vehÃ­culos y motos", icon:"ðŸš—ðŸï¸" },
    { text:"Traslado de larga distancia", icon:"ðŸ›£ï¸" },
    { text:"Apertura de vehÃ­culo (puertas cerradas)", icon:"ðŸ”‘" },
    { text:"Suministro de combustible", icon:"â›½" },
    { text:"Asistencia a motos", icon:"ðŸï¸" },
    { text:"Rescate fuera de vÃ­a", icon:"ðŸ†˜" },
    { text:"VehÃ­culo alto (+2,10 m)", icon:"ðŸ“" },
    { text:"Otro", icon:"â“" }
  ];

  const select = document.getElementById('servicio');
  const ul = document.querySelector('ul.services') || document.getElementById('servicesList');

  if (select && ul){
    select.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.disabled = true;
    ph.selected = true;
    ph.textContent = 'Selecciona un servicio';
    select.appendChild(ph);

    SERVICES.forEach(s=>{
      const o = document.createElement('option');
      o.value = s.text;
      o.textContent = s.text;
      select.appendChild(o);
    });

    ul.innerHTML = '';
    SERVICES.filter(s=>s.text!=='Otro').forEach(s=>{
      const li = document.createElement('li');
      li.textContent = `${s.icon} ${s.text}`;
      ul.appendChild(li);
    });
  }

  // MENSAJE
  function buildMessage(data){
    const l = [];
    l.push(`Hola GrÃºas CÃ©sar, necesito *${data.servicio}*.`);
    l.push('');
    if (data.ubicacion) l.push(`ðŸ“ UbicaciÃ³n: ${data.ubicacion}`);
    if (data.gps) l.push(`ðŸ“¡ GPS: https://maps.google.com/?q=${data.gps.lat},${data.gps.lng} (Â±${data.gps.acc}m)`);
    if (data.matricula) l.push(`ðŸš˜ MatrÃ­cula: ${data.matricula}`);
    if (data.vehiculo) l.push(`ðŸ”Ž Modelo: ${data.vehiculo}`);
    if (data.detalles) l.push(`ðŸ“ Detalles: ${data.detalles}`);
    l.push('');
    if (data.nombre) l.push(`ðŸ‘¤ Nombre: ${data.nombre}`);
    if (data.tel) l.push(`ðŸ“ž Tel: ${data.tel}`);
    return l.join('\\n');
  }

  // FORM
  const form = document.getElementById('asistenciaForm');
  const telInput = document.getElementById('telefono');

  if (telInput){
    telInput.addEventListener('input',()=>{
      telInput.value = telInput.value.replace(/[^0-9+]/g,'');
    });
  }

  if (form){
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const btn = document.getElementById('enviarBtn');

      if (document.getElementById('empresa')?.value) return;

      if (!form.checkValidity()){
        setEstado('Revisa los campos obligatorios.');
        form.reportValidity();
        return;
      }

      const tel = normalizarTelefono(form.telefono.value);
      if (!/^\+\d{8,15}$/.test(tel)){
        setEstado('TelÃ©fono no vÃ¡lido. Ej: +34633078354');
        telInput?.focus();
        return;
      }

      if (btn){
        btn.disabled = true;
        btn.textContent = 'Abriendo WhatsAppâ€¦';
      }

      const data = {
        servicio: form.servicio.value,
        nombre: linea(form.nombre.value),
        ubicacion: linea(form.ubicacion.value),
        matricula: linea(form.matricula.value),
        vehiculo: linea(form.vehiculo.value),
        detalles: linea(form.detalles.value),
        gps,
        tel
      };

      const textEncoded = encodeURIComponent(buildMessage(data));
      const waWeb = `https://wa.me/${PHONE_DIGITS}?text=${textEncoded}&utm_source=web&utm_medium=form&utm_campaign=wa`;
      const waApp = `whatsapp://send?phone=${PHONE_E164}&text=${textEncoded}`;

      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (isMobile){
        window.location.href = waApp;
        setTimeout(()=>window.open(waWeb,'_blank','noopener'),700);
      } else {
        window.open(waWeb,'_blank','noopener');
      }

      setTimeout(()=>{
        if (btn){
          btn.disabled = false;
          btn.textContent = 'ðŸ’¬ Enviar por WhatsApp';
        }
      },1500);
    });
  }
});
</script>
